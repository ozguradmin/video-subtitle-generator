<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geli≈ümi≈ü Video Altyazƒ± D√ºzenleyici</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
            overscroll-behavior: none;
        }
        [x-cloak] { display: none !important; }
        .accent-primary { accent-color: #137fec; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200"
      x-data="videoEditor()">

    <!-- Ana Konteyner -->
    <div class="flex min-h-screen flex-col">
        <!-- 1. Y√ºkleme ve Kontrol Ekranƒ± -->
        <div x-show="currentScreen === 'upload'" x-transition.opacity.duration.200ms>
            <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm shadow-sm">
                <div class="container mx-auto px-4"><div class="flex h-16 items-center justify-between"><h1 class="text-xl font-bold text-gray-900 dark:text-white">Video Subtitle Generator</h1></div></div>
            </header>
            <main class="flex-grow container mx-auto px-4 py-8">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Upload Section -->
                    <div class="rounded-lg bg-background-light/50 dark:bg-background-dark/50 p-6 shadow">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">1. Video Y√ºkle</h2>
                        <div class="flex flex-col sm:flex-row gap-4 items-end">
                            <div class="w-full sm:flex-1 relative">
                                <input id="video-upload" type="file" @change="handleFileSelect($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <label for="video-upload" class="flex items-center justify-center w-full h-12 px-4 rounded border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 cursor-pointer hover:border-primary hover:text-primary">
                                    <span class="material-symbols-outlined mr-2">upload_file</span>
                                    <span>Video Se√ß</span>
                                </label>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Se√ßilen dosya: <span class="font-medium" x-text="fileName">None</span></p>
                </div>
                            <button @click="handleUpload" :disabled="isLoading" class="w-full sm:w-auto flex items-center justify-center rounded bg-primary px-6 py-3 text-sm font-bold text-white hover:bg-opacity-90 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span class="truncate" x-text="isLoading ? 'ƒ∞≈üleniyor...' : 'Y√ºkle ve Altyazƒ± Olu≈ütur'"></span>
                            </button>
                </div>
                </div>
                    <!-- Status/Log Section -->
                    <div class="rounded-lg bg-background-light/50 dark:bg-background-dark/50 p-6 shadow" x-show="statusMessage || logs.length > 0">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-lg font-bold text-gray-900 dark:text-white">Durum & Kayƒ±tlar</h2>
                             <button @click="copyLogsToClipboard" class="flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 px-3 py-1 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                <span class="material-symbols-outlined mr-2 text-base">content_copy</span>
                                <span x-text="logCopyButtonText">Kopyala</span>
                            </button>
                </div>
                        <p class="text-sm mb-4" :class="{ 'text-green-500': statusType === 'success', 'text-red-500': statusType === 'error', 'text-gray-400': statusType === 'processing' }" x-text="statusMessage"></p>
                        <div x-show="logs.length > 0">
                           <div class="p-4 rounded bg-gray-100 dark:bg-gray-800 h-48 overflow-y-auto">
                                <pre class="text-xs text-gray-600 dark:text-gray-400" x-text="logs.join('\n') || 'G√∂r√ºnt√ºlenecek kayƒ±t yok.'"></pre>
            </div>
                </div>
                </div>
                </div>
            </main>
                </div>

        <!-- 2. Video √ñnizleme Ekranƒ± -->
        <div x-show="currentScreen === 'preview'" x-transition.opacity.duration.200ms class="relative flex flex-col h-screen justify-between">
             <header class="flex items-center p-4 border-b border-white/10 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
                <div class="w-10"></div>
                <h1 class="text-lg font-bold text-center flex-1 text-black dark:text-white">Video √ñnizleme</h1>
                <button @click="logsOpen = !logsOpen" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20">
                    <span class="material-symbols-outlined">description</span>
                </button>
            </header>
            <main class="flex-grow flex items-center justify-center bg-black">
                <video x-show="videoPreviewUrl" :src="videoPreviewUrl" controls class="max-w-full max-h-full"></video>
                <div x-show="!videoPreviewUrl" class="text-center text-white p-4"><p>ƒ∞≈ülenmi≈ü video burada g√∂r√ºnecektir.</p></div>
            </main>
            <footer class="bg-background-light dark:bg-background-dark shadow-inner pt-2 pb-5">
                <nav class="flex justify-around items-center">
                    <a href="#" @click.prevent="currentScreen = 'preview'" class="flex flex-col items-center gap-1 text-primary">
                        <div class="p-2 bg-primary/20 rounded-full"><span class="material-symbols-outlined">movie</span></div>
                        <span class="text-xs font-medium">√ñnizleme</span>
                    </a>
                    <a href="#" @click.prevent="currentScreen = 'editor'" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">subtitles</span></div>
                        <span class="text-xs font-medium">Altyazƒ±lar</span>
                    </a>
                    <a href="#" @click.prevent="currentScreen = 'style_editor'" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">tune</span></div>
                        <span class="text-xs font-medium">Stil</span>
                    </a>
                    <a href="#" @click.prevent="handleDownload" :class="{'opacity-50 cursor-not-allowed': !videoPreviewUrl}" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">download</span></div>
                        <span class="text-xs font-medium">ƒ∞ndir</span>
                    </a>
                </nav>
            </footer>

            <!-- Logs Panel -->
            <div x-show="logsOpen" @click.away="logsOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-4" class="absolute top-16 right-4 w-full max-w-md bg-background-light dark:bg-background-dark shadow-lg rounded-lg p-4 z-20 border border-gray-200/20 dark:border-gray-700/50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg">ƒ∞≈ülem Kayƒ±tlarƒ±</h3>
                    <button @click="copyLogsToClipboard" class="flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 px-3 py-1 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <span class="material-symbols-outlined mr-2 text-base">content_copy</span>
                        <span x-text="logCopyButtonText">Kopyala</span>
                    </button>
            </div>
                <div class="p-2 rounded bg-gray-100 dark:bg-gray-800 h-64 overflow-y-auto">
                    <pre class="text-xs text-gray-600 dark:text-gray-400" x-text="logs.join('\n') || 'G√∂r√ºnt√ºlenecek kayƒ±t yok.'"></pre>
                </div>
            </div>
        </div>

        <!-- 3. Altyazƒ± D√ºzenleyici Ekranƒ± -->
        <div x-show="currentScreen === 'editor'" x-transition.opacity.duration.200ms class="flex flex-col h-screen">
            <header class="flex items-center justify-between border-b border-gray-200/10 p-4 backdrop-blur-sm">
                <button @click="currentScreen = 'preview'" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 class="text-lg font-bold">Altyazƒ± D√ºzenleyici</h1>
                <div class="flex items-center gap-2">
                    <button @click="undo()" :disabled="historyIndex <= 0" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20 disabled:opacity-50">
                        <span class="material-symbols-outlined">undo</span>
                    </button>
                    <button @click="redo()" :disabled="historyIndex >= history.length - 1" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20 disabled:opacity-50">
                        <span class="material-symbols-outlined">redo</span>
                    </button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4">
                <div class="space-y-6">
                    <!-- Altyazƒ± yoksa mesaj g√∂ster -->
                    <div x-show="currentSubtitles.length === 0" class="text-center py-8">
                        <div class="text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined text-4xl mb-2 block">subtitles_off</span>
                            <p>Hen√ºz altyazƒ± y√ºklenmedi. L√ºtfen √∂nce bir video y√ºkleyin.</p>
                        </div>
                    </div>
                    
                    <!-- Altyazƒ± edit√∂r√º -->
                    <div x-show="currentSubtitles.length > 0" class="rounded-lg border border-primary/50 bg-background-light/50 p-4 shadow-lg ring-1 ring-primary/20 dark:bg-background-dark/50"
                         @input="recordHistory()">
                        <div class="mb-3 flex items-center justify-between">
                             <div class="flex items-center gap-3">
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].speaker" class="inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-1 text-xs font-semibold text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 border-0 focus:ring-2 focus:ring-primary">
                                <div class="flex items-center gap-2 rounded-full bg-gray-200 dark:bg-gray-700 pl-3">
                                    <input type="color" 
                                           :value="getCurrentSubtitleColor()"
                                           @input.debounce.150ms="currentSubtitles[activeSubtitleIndex].overrideColor = $event.target.value; recordHistory()"
                                           class="w-6 h-6 p-0 border-0 rounded-full cursor-pointer appearance-none bg-transparent">
                                    <input type="text" 
                                           :value="getCurrentSubtitleColor()"
                                           @input.debounce.300ms="currentSubtitles[activeSubtitleIndex].overrideColor = $event.target.value; recordHistory()"
                                           class="w-20 bg-transparent text-xs font-mono focus:ring-0 border-0">
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400" x-text="(activeSubtitleIndex + 1) + ' / ' + currentSubtitles.length"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Ba≈ülangƒ±√ß</label>
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].startTime" class="mt-1 block w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Biti≈ü</label>
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].endTime" class="mt-1 block w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white">
                            </div>
                </div>
                        <div class="mt-3">
                            <textarea x-model="currentSubtitles[activeSubtitleIndex].line" class="min-h-[100px] w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white" rows="4"></textarea>
            </div>
            <div class="mt-4 flex justify-end">
                <button @click="removeSubtitle(activeSubtitleIndex)" class="flex items-center gap-2 rounded-md bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-500 hover:bg-red-500/20 dark:bg-red-500/20 dark:text-red-400 dark:hover:bg-red-500/30">
                    <span class="material-symbols-outlined text-base">delete</span>
                    <span>Bu Altyazƒ±yƒ± Sil</span>
                </button>
            </div>
        </div>
                    <div class="flex items-center justify-between">
                        <button @click="prevSubtitle()" :disabled="activeSubtitleIndex === 0" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 disabled:opacity-50"><span class="material-symbols-outlined">chevron_left</span></button>
                        
                        <button @click="addNewSubtitle()" class="flex h-12 w-12 items-center justify-center rounded-full bg-green-500/20 text-green-500 hover:bg-green-500/30">
                            <span class="material-symbols-outlined">add</span>
                        </button>

                        <div class="flex items-center gap-2">
                             <template x-for="(sub, index) in currentSubtitles.slice(Math.max(0, activeSubtitleIndex-2), Math.min(currentSubtitles.length, activeSubtitleIndex+3))">
                                <button @click="activeSubtitleIndex = currentSubtitles.indexOf(sub)" class="h-2.5 w-2.5 rounded-full" :class="currentSubtitles.indexOf(sub) === activeSubtitleIndex ? 'bg-primary' : 'bg-gray-300 dark:bg-gray-600'"></button>
                            </template>
                        </div>
                        <button @click="nextSubtitle()" :disabled="activeSubtitleIndex === currentSubtitles.length - 1" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 disabled:opacity-50"><span class="material-symbols-outlined">chevron_right</span></button>
            </div>
        </div>
            </main>
             <footer class="sticky bottom-0 border-t border-gray-200/10 bg-background-light/80 p-4 backdrop-blur-sm dark:bg-background-dark/80">
                <button @click="reprocessVideo()" :disabled="isLoading" class="w-full rounded-lg bg-primary py-3 text-sm font-bold text-white transition hover:bg-primary/90 disabled:bg-gray-400">
                    <span x-text="isLoading ? 'Uygulanƒ±yor...' : 'Deƒüi≈üiklikleri Kaydet ve Uygula'"></span>
                </button>
            </footer>
    </div>

        <!-- 4. Stil D√ºzenleyici Ekranƒ± -->
        <div x-show="currentScreen === 'style_editor'" x-transition.opacity.duration.200ms class="flex flex-col h-screen">
             <header class="flex items-center justify-between border-b border-gray-200/10 p-4 backdrop-blur-sm">
                <button @click="currentScreen = 'preview'" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 class="text-lg font-bold">Stil ve Zamanlama Ayarlarƒ±</h1>
                <div class="h-10 w-10"></div>
            </header>
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Live Style Preview -->
                <div class="mb-6">
                    <div class="relative w-full aspect-[9/16] bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden">
                        <div class="absolute text-center"
                             :style="getLivePreviewStyle()">
                            <span class="px-2" :style="getLivePreviewBackgroundStyle()">√ñrnek Altyazƒ± Metni</span>
                        </div>
                    </div>
                </div>

                 <div class="grid grid-cols-1 gap-6">
                     <div>
                        <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">Altyazƒ± Stili</h3>
                        <div class="space-y-4">
                            <!-- Font Family -->
                            <div>
                                <label for="fontFamily" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Yazƒ± Tipi</label>
                                <select id="fontFamily" x-model="styleSettings.fontFamily" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                                    <option>Roboto</option>
                                    <option>Avenir</option>
                                </select>
                            </div>
                            <!-- Font Size -->
                            <div>
                                <label for="fontSize" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Yazƒ± Tipi Boyutu: <span x-text="styleSettings.fontSize" class="font-bold"></span></label>
                                <input type="range" id="fontSize" x-model.number="styleSettings.fontSize" min="10" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                            </div>
                             <!-- Vertical Position -->
                             <div>
                                <label for="verticalPosition" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dikey Konum: <span x-text="styleSettings.marginV" class="font-bold"></span></label>
                                <input type="range" id="verticalPosition" x-model.number="styleSettings.marginV" min="0" max="1000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                            </div>
                            <!-- Italic -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ƒ∞talik</span>
                                <button @click="styleSettings.italic = !styleSettings.italic" :class="{'bg-primary': styleSettings.italic, 'bg-gray-200 dark:bg-gray-700': !styleSettings.italic}" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2" role="switch" aria-checked="false">
                                    <span :class="{'translate-x-5': styleSettings.italic, 'translate-x-0': !styleSettings.italic}" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">G√∂r√ºn√ºm ve Efektler</h3>
                        <div class="space-y-4">
                           
                            <!-- Shadow -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">G√∂lge Ekle</span>
                                <button @click="styleSettings.shadow = !styleSettings.shadow" :class="{'bg-primary': styleSettings.shadow, 'bg-gray-200 dark:bg-gray-700': !styleSettings.shadow}" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2" role="switch" aria-checked="false">
                                    <span :class="{'translate-x-5': styleSettings.shadow, 'translate-x-0': !styleSettings.shadow}" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                </button>
                            </div>
                             <!-- Outline -->
                             <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dƒ±≈ü √áizgi Ekle</span>
                                <button @click="styleSettings.outline = !styleSettings.outline" :class="{'bg-primary': styleSettings.outline, 'bg-gray-200 dark:bg-gray-700': !styleSettings.outline}" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2" role="switch" aria-checked="false">
                                    <span :class="{'translate-x-5': styleSettings.outline, 'translate-x-0': !styleSettings.outline}" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                </button>
                            </div>
                             <!-- Background -->
                             <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Arka Plan Rengi</span>
                                <input type="color" x-model="styleSettings.backgroundColor" class="w-10 h-10">
                            </div>
                             <div>
                                <label for="backgroundOpacity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Arka Plan Opaklƒ±ƒüƒ±: <span x-text="styleSettings.backgroundOpacity" class="font-bold"></span></label>
                                <input type="range" id="backgroundOpacity" x-model.number="styleSettings.backgroundOpacity" min="0" max="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                            </div>
                            <!-- Animation Style -->
                            <div>
                                <label for="animationStyle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Altyazƒ± Animasyonu</label>
                                <select id="animationStyle" x-model="styleSettings.animationStyle" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                                    <option value="none">Yok</option>
                                    <option value="fadeIn">Yumu≈üak Giri≈ü (Fade In)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                 </div>
            </main>
             <footer class="sticky bottom-0 border-t border-gray-200/10 bg-background-light/80 p-4 backdrop-blur-sm dark:bg-background-dark/80">
                <button @click="reprocessVideo()" :disabled="isLoading" class="w-full rounded-lg bg-primary py-3 text-sm font-bold text-white transition hover:bg-primary/90 disabled:bg-gray-400">
                     <span x-text="isLoading ? 'Uygulanƒ±yor...' : 'Stil Deƒüi≈üikliklerini Uygula'"></span>
                </button>
            </footer>
        </div>

    </div>

    <script>
    function videoEditor() {
        return {
            // --- STATE ---
            currentScreen: 'upload', // 'upload', 'preview', 'editor', 'style_editor'
            fileName: 'None',
            statusMessage: '',
            statusType: 'processing', // 'processing', 'success', 'error'
            logs: [],
            isLoading: false,
            logsOpen: false,
            logCopyButtonText: 'Kopyala',
            
            originalVideoFile: null, // Orijinal video dosyasƒ±nƒ± saklamak i√ßin
            currentVideoPath: '', // Bu artƒ±k Vercel i√ßin kullanƒ±lmayacak
            videoPreviewUrl: '',
            currentSubtitles: [],
            activeSubtitleIndex: 0,
            history: [],
            historyIndex: -1,
            
            // Style Settings
            styleSettings: {
                fontSize: 50,
                marginV: 300,
                extendDuration: 0.5,
                italic: false,
                speakerColors: {}, // Ba≈ülangƒ±√ßta bo≈ü, dinamik dolacak
                fontFamily: 'Roboto', // Font se√ßimi
                // Yeni ayarlar
                maxWidth: 80, // Metin geni≈üliƒüi (%)
                marginH: 20, // Sol/saƒü kenar bo≈üluƒüu (px)
                lineSpacing: 5, // Satƒ±r arasƒ± bo≈üluk (px)
                textAlign: 'center', // Metin hizalama (left, center, right)
                shadow: true, // G√∂lge efekti
                outline: true, // Kontur efekti
                outlineWidth: 2, // Kontur kalƒ±nlƒ±ƒüƒ± (px)
                shadowOffset: 2, // G√∂lge mesafesi (px)
                backgroundColor: 'black', // Arka plan rengi
                backgroundOpacity: 0.5, // Arka plan ≈üeffaflƒ±ƒüƒ± (0-1)
                animationStyle: 'none' // Yeni eklenen animasyon ayarƒ±
            },

            // --- METHODS ---
            
            // --- Navigation ---
            nextSubtitle() {
                if (this.activeSubtitleIndex < this.currentSubtitles.length - 1) {
                    this.activeSubtitleIndex++;
                }
            },
            prevSubtitle() {
                if (this.activeSubtitleIndex > 0) {
                    this.activeSubtitleIndex--;
                }
            },
            
            // --- History ---
            recordHistory: _.debounce(function() {
                if (this.historyIndex < this.history.length - 1) {
                    this.history.splice(this.historyIndex + 1);
                }
                this.history.push(JSON.parse(JSON.stringify(this.currentSubtitles)));
                this.historyIndex++;
            }, 300),

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.currentSubtitles = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                }
            },

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.currentSubtitles = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                }
            },

            // --- UI Helpers ---
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.fileName = file.name;
                    this.originalVideoFile = file; // Dosyayƒ± state'e kaydet
                } else {
                    this.fileName = 'Hi√ßbiri';
                    this.originalVideoFile = null;
                }
            },
            
            addLog(message) {
                this.logs.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            },
            
            getCurrentSubtitleColor() {
                const currentSub = this.currentSubtitles[this.activeSubtitleIndex];
                if (!currentSub) return '#ffffff';
                
                // √ñnce override rengi kontrol et
                if (currentSub.overrideColor) {
                    return currentSub.overrideColor;
                }
                
                // Sonra konu≈ümacƒ±nƒ±n varsayƒ±lan rengini kontrol et
                if (currentSub.speaker && this.styleSettings.speakerColors[currentSub.speaker]) {
                    return this.styleSettings.speakerColors[currentSub.speaker];
                }
                
                // Son olarak varsayƒ±lan renk
                return '#ffff00'; // Sarƒ±
            },
            
            updateStatus(message, type, logs = null) {
                this.statusMessage = message;
                this.statusType = type;
                if(logs) {
                    this.logs = Array.isArray(logs) ? logs : [logs];
                }
            },
            
            copyLogsToClipboard() {
                navigator.clipboard.writeText(this.logs.join('\n')).then(() => {
                    this.logCopyButtonText = 'Kopyalandƒ±!';
                    setTimeout(() => this.logCopyButtonText = 'Kopyala', 2000);
                }).catch(err => {
                    console.error('Loglar kopyalanamadƒ±: ', err);
                    this.logCopyButtonText = 'Hata!';
                    setTimeout(() => this.logCopyButtonText = 'Kopyala', 2000);
                });
            },
            
            populateSpeakerColors() {
                const colors = ['#FFFF00', '#FFFFFF', '#00FFFF', '#FF00FF', '#00FF00']; // Sarƒ±, Beyaz, Mavi, Pembe, Ye≈üil
                const speakers = new Set(this.currentSubtitles.map(s => s.speaker));
                const newSpeakerColors = {};
                let colorIndex = 0;
                speakers.forEach(speaker => {
                    if (!this.styleSettings.speakerColors[speaker]) {
                         newSpeakerColors[speaker] = colors[colorIndex % colors.length];
                         colorIndex++;
                    } else {
                        newSpeakerColors[speaker] = this.styleSettings.speakerColors[speaker];
                    }
                });
                this.styleSettings.speakerColors = newSpeakerColors;
                
                // Altyazƒ±larƒ±n overrideColor alanlarƒ±nƒ± da g√ºncelle - Alpine.js'in algƒ±lamasƒ± i√ßin yeni dizi olu≈ütur
                this.currentSubtitles = this.currentSubtitles.map(sub => {
                    if (!sub.overrideColor && sub.speaker && this.styleSettings.speakerColors[sub.speaker]) {
                        return { ...sub, overrideColor: this.styleSettings.speakerColors[sub.speaker] };
                    }
                    return sub;
                });
            },

            // --- API Calls ---
            async handleUpload() {
                const videoInput = document.getElementById('video-upload');
                if (!videoInput.files[0]) {
                    this.updateStatus('L√ºtfen √∂nce bir video dosyasƒ± se√ßin.', 'error');
                    return;
                }

                this.isLoading = true;
                this.logs = []; // Loglarƒ± temizle
                this.updateStatus('Video y√ºkleniyor ve i≈üleniyor...', 'processing');
                
                // Anlƒ±k log g√ºncellemesi i√ßin
                this.addLog('üì§ Video y√ºkleniyor...');

                const formData = new FormData();
                formData.append('video', videoInput.files[0]);

                try {
                    const response = await fetch('/api/upload', { method: 'POST', body: formData });
                    const result = await response.json();
                    
                    // Loglarƒ± anlƒ±k olarak g√ºncelle
                    if (result.logs && Array.isArray(result.logs)) {
                        this.logs = [...result.logs];
                    }

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Sunucu hatasƒ± olu≈ütu.');
                    }

                    this.updateStatus('Ba≈üarƒ±yla tamamlandƒ±!', 'success');
                    
                    // Vercel API'den gelen veriyi i≈üle
                    if (result.videoBuffer) {
                        // Base64 video data'sƒ±nƒ± blob URL'e √ßevir
                        const videoBlob = new Blob([Uint8Array.from(atob(result.videoBuffer), c => c.charCodeAt(0))], { type: 'video/mp4' });
                        this.videoPreviewUrl = URL.createObjectURL(videoBlob);
                    } else if (result.downloadUrl) {
                        this.videoPreviewUrl = result.downloadUrl;
                    }
                    
                    // Altyazƒ±larƒ± i≈üle
                    if (result.subtitles && result.subtitles.subtitles) {
                        this.currentSubtitles = result.subtitles.subtitles.map(s => ({
                            ...s, 
                            startTime: s.startTime.toFixed(3), 
                            endTime: s.endTime.toFixed(3),
                            overrideColor: ''
                        }));
                    } else {
                        // Fallback: bo≈ü altyazƒ± listesi
                        this.currentSubtitles = [];
                    }
                    
                    this.activeSubtitleIndex = 0;
                    this.populateSpeakerColors();
                    // History init
                    this.history = [JSON.parse(JSON.stringify(this.currentSubtitles))];
                    this.historyIndex = 0;
                    this.currentScreen = 'preview';

                } catch (error) {
                    console.error('Y√ºkleme hatasƒ±:', error);
                    this.addLog('‚ùå Hata: ' + error.message);
                    this.updateStatus(error.message, 'error');
                } finally {
                    this.isLoading = false;
                }
            },

            async reprocessVideo() {
                if (!this.originalVideoFile || !this.currentSubtitles) {
                    this.updateStatus('Yeniden i≈ülemek i√ßin video verisi bulunamadƒ±.', 'error');
                    return;
                }

                this.isLoading = true;
                this.logs = []; // Loglarƒ± temizle
                this.updateStatus('Deƒüi≈üiklikler uygulanƒ±yor...', 'processing');
                this.addLog('üîÑ Video yeniden i≈üleniyor...');
                
                const formData = new FormData();
                formData.append('video', this.originalVideoFile); // Orijinal video dosyasƒ±nƒ± g√∂nder
                
                // Convert times back to float for processing
                const subtitlesToProcess = this.currentSubtitles.map(s => ({
                    ...s,
                    startTime: parseFloat(s.startTime),
                    endTime: parseFloat(s.endTime)
                }));
                formData.append('subtitles', JSON.stringify({ subtitles: subtitlesToProcess }));
                formData.append('selectedStyle', JSON.stringify(this.styleSettings));
                formData.append('speakerColors', JSON.stringify(this.styleSettings.speakerColors));

                // Debug loglarƒ±
                this.addLog(`üé® G√∂nderilen stil ayarlarƒ±:`);
                this.addLog(`   Font Boyutu: ${this.styleSettings.fontSize}, Dikey Konum: ${this.styleSettings.marginV}, ƒ∞talik: ${this.styleSettings.italic}`);
                this.addLog(`   Metin Geni≈üliƒüi: ${this.styleSettings.maxWidth}%, Kenar Bo≈üluƒüu: ${this.styleSettings.marginH}px, Satƒ±r Arasƒ±: ${this.styleSettings.lineSpacing}px`);
                this.addLog(`   Hizalama: ${this.styleSettings.textAlign}, G√∂lge: ${this.styleSettings.shadow}, Kontur: ${this.styleSettings.outline}`);
                
                const background = this.styleSettings.backgroundColor + '@' + this.styleSettings.backgroundOpacity;
                this.addLog(`   Arka Plan: ${background}`);
                this.addLog(`   Konu≈ümacƒ± Renkleri: ${JSON.stringify(this.styleSettings.speakerColors)}`);

                try {
                    const response = await fetch('/api/reprocess', { 
                        method: 'POST',
                        body: formData,
                        signal: AbortSignal.timeout(300000) // 5 dakika timeout
                    });
                    const result = await response.json();
                    
                    // Loglarƒ± anlƒ±k olarak g√ºncelle
                    if (result.logs && Array.isArray(result.logs)) {
                        this.logs = [...result.logs];
                    }

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Sunucu hatasƒ± olu≈ütu.');
                    }
                    
                    this.updateStatus('Deƒüi≈üiklikler ba≈üarƒ±yla uygulandƒ±!', 'success');
                    
                    // Vercel API'den gelen veriyi i≈üle
                    if (result.videoBuffer) {
                        // Base64 video data'sƒ±nƒ± blob URL'e √ßevir
                        const videoBlob = new Blob([Uint8Array.from(atob(result.videoBuffer), c => c.charCodeAt(0))], { type: 'video/mp4' });
                        this.videoPreviewUrl = URL.createObjectURL(videoBlob);
                    } else if (result.downloadUrl) {
                        this.videoPreviewUrl = result.downloadUrl + `?t=${new Date().getTime()}`; // Cache bust
                    }
                    
                    // Altyazƒ±larƒ± g√ºncelle (eƒüer backend'den d√∂nd√ºyse)
                    if (result.subtitles && result.subtitles.subtitles) {
                        this.currentSubtitles = result.subtitles.subtitles.map(s => ({
                            ...s, 
                            startTime: s.startTime.toFixed(3), 
                            endTime: s.endTime.toFixed(3),
                            overrideColor: ''
                        }));
                    }
                    
                    this.currentScreen = 'preview';

                } catch (error) {
                    console.error('Yeniden i≈üleme hatasƒ±:', error);
                    this.addLog('‚ùå Hata: ' + error.message);
                    this.updateStatus(error.message, 'error');
                } finally {
                    this.isLoading = false;
                }
            },

            handleDownload() {
                if (!this.videoPreviewUrl) return;
                            const a = document.createElement('a');
                a.href = this.videoPreviewUrl.split('?')[0]; // Sorunlu cache-busting parametresini kaldƒ±r
                a.download = `subtitled_video_${Date.now()}.mp4`; // Temiz bir dosya adƒ± ver
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
            },
            
            extendAllDurations() {
                const extendSeconds = parseFloat(this.styleSettings.extendDuration);
                if (isNaN(extendSeconds) || extendSeconds <= 0) {
                    alert('L√ºtfen ge√ßerli bir uzatma s√ºresi girin.');
                    return;
                }
            
                const updatedSubs = this.currentSubtitles.map((sub, i) => {
                    const nextSub = this.currentSubtitles[i + 1];
                    const currentEndTime = parseFloat(sub.endTime);
                    let potentialNewEndTime = currentEndTime + extendSeconds;
            
                    if (nextSub && potentialNewEndTime > parseFloat(nextSub.startTime)) {
                        potentialNewEndTime = parseFloat(nextSub.startTime);
                    }
                    return {...sub, endTime: potentialNewEndTime.toFixed(3)};
                });
                
                this.currentSubtitles = updatedSubs;
                alert('Biti≈ü s√ºreleri g√ºncellendi. Deƒüi≈üiklikleri kalƒ±cƒ± hale getirmek i√ßin "Stil Deƒüi≈üikliklerini Uygula" butonuna tƒ±klayƒ±n.');
            },

            removeSubtitle(index) {
                this.currentSubtitles.splice(index, 1);
                // Eƒüer silinen altyazƒ± son altyazƒ± ise ve index 0'dan b√ºy√ºkse, bir √∂ncekine git
                if (this.activeSubtitleIndex >= this.currentSubtitles.length && this.activeSubtitleIndex > 0) {
                    this.activeSubtitleIndex--;
                }
                this.recordHistory(); // History'i g√ºncelle
            },

            getLivePreviewStyle() {
                const styles = {
                    fontFamily: this.styleSettings.fontFamily,
                    fontSize: `${this.styleSettings.fontSize}px`,
                    fontStyle: this.styleSettings.italic ? 'italic' : 'normal',
                    color: '#FFFF00', // Sabit sarƒ± renk
                    textAlign: this.styleSettings.textAlign,
                    '--webkit-text-stroke-width': this.styleSettings.outline ? `${this.styleSettings.outlineWidth}px` : '0',
                    '--webkit-text-stroke-color': 'black',
                    textShadow: this.styleSettings.shadow ? `black ${this.styleSettings.shadowOffset}px ${this.styleSettings.shadowOffset}px 0px` : 'none',
                    bottom: `${(this.styleSettings.marginV / 1920) * 100}%`, // Yakla≈üƒ±k dikey konumlandƒ±rma
                    width: `${this.styleSettings.maxWidth}%`,
                    padding: `0 ${this.styleSettings.marginH}px`,
                };
                 return Object.entries(styles).map(([key, value]) => `${key}: ${value}`).join(';');
            },

            getLivePreviewBackgroundStyle() {
                const rgbaColor = `rgba(0, 0, 0, ${this.styleSettings.backgroundOpacity})`;
                const styles = {
                    backgroundColor: rgbaColor,
                    boxDecorationBreak: 'clone',
                    '-webkit-box-decoration-break': 'clone',
                };
                return Object.entries(styles).map(([key, value]) => `${key}: ${value}`).join(';');
            },

            addNewSubtitle() {
                const lastSubtitle = this.currentSubtitles[this.currentSubtitles.length - 1];
                const newStartTime = lastSubtitle ? parseFloat(lastSubtitle.endTime) + 0.1 : 0;
                const newEndTime = newStartTime + 2.0;

                const newSubtitle = {
                    speaker: lastSubtitle ? lastSubtitle.speaker : 'Konu≈ümacƒ± 1',
                    startTime: newStartTime.toFixed(3),
                    endTime: newEndTime.toFixed(3),
                    line: 'Yeni altyazƒ±...',
                    overrideColor: ''
                };

                this.currentSubtitles.push(newSubtitle);
                this.activeSubtitleIndex = this.currentSubtitles.length - 1;
                this.recordHistory();
            }
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</body>
</html>
