<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Video Altyazı Düzenleyici</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
            overscroll-behavior: none;
        }
        [x-cloak] { display: none !important; }
        .accent-primary { accent-color: #137fec; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200"
      x-data="videoEditor()">

    <!-- Ana Konteyner -->
    <div class="flex min-h-screen flex-col">
        <!-- 1. Yükleme ve Kontrol Ekranı -->
        <div x-show="currentScreen === 'upload'" x-transition.opacity.duration.200ms>
            <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm shadow-sm">
                <div class="container mx-auto px-4"><div class="flex h-16 items-center justify-between"><h1 class="text-xl font-bold text-gray-900 dark:text-white">Video Subtitle Generator</h1></div></div>
            </header>
            <main class="flex-grow container mx-auto px-4 py-8">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Upload Section -->
                    <div class="rounded-lg bg-background-light/50 dark:bg-background-dark/50 p-6 shadow">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">1. Video Yükle</h2>
                        <div class="flex flex-col sm:flex-row gap-4 items-end">
                            <div class="w-full sm:flex-1 relative">
                                <input id="video-upload" type="file" @change="handleFileSelect($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <label for="video-upload" class="flex items-center justify-center w-full h-12 px-4 rounded border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 cursor-pointer hover:border-primary hover:text-primary">
                                    <span class="material-symbols-outlined mr-2">upload_file</span>
                                    <span>Video Seç</span>
                                </label>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Seçilen dosya: <span class="font-medium" x-text="fileName">None</span></p>
                </div>
                            <button @click="handleUpload" :disabled="isLoading" class="w-full sm:w-auto flex items-center justify-center rounded bg-primary px-6 py-3 text-sm font-bold text-white hover:bg-opacity-90 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span class="truncate" x-text="isLoading ? 'İşleniyor...' : 'Yükle ve Altyazı Oluştur'"></span>
                            </button>
                </div>
                </div>
                    <!-- Status/Log Section -->
                    <div class="rounded-lg bg-background-light/50 dark:bg-background-dark/50 p-6 shadow" x-show="statusMessage || logs.length > 0">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-lg font-bold text-gray-900 dark:text-white">Durum & Kayıtlar</h2>
                             <button @click="copyLogsToClipboard" class="flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 px-3 py-1 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                <span class="material-symbols-outlined mr-2 text-base">content_copy</span>
                                <span x-text="logCopyButtonText">Kopyala</span>
                            </button>
                </div>
                        <p class="text-sm mb-4" :class="{ 'text-green-500': statusType === 'success', 'text-red-500': statusType === 'error', 'text-gray-400': statusType === 'processing' }" x-text="statusMessage"></p>
                        <div x-show="logs.length > 0">
                           <div class="p-4 rounded bg-gray-100 dark:bg-gray-800 h-48 overflow-y-auto">
                                <pre class="text-xs text-gray-600 dark:text-gray-400" x-text="logs.join('\n') || 'Görüntülenecek kayıt yok.'"></pre>
            </div>
                </div>
            </div>
        </div>
            </main>
        </div>

        <!-- 2. Video Önizleme Ekranı -->
        <div x-show="currentScreen === 'preview'" x-transition.opacity.duration.200ms class="relative flex flex-col h-screen justify-between">
             <header class="flex items-center p-4 border-b border-white/10 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
                <div class="w-10"></div>
                <h1 class="text-lg font-bold text-center flex-1 text-black dark:text-white">Video Önizleme</h1>
                <button @click="logsOpen = !logsOpen" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20">
                    <span class="material-symbols-outlined">description</span>
                </button>
            </header>
            <main class="flex-grow flex items-center justify-center bg-black">
                <video x-show="videoPreviewUrl" :src="videoPreviewUrl" controls class="max-w-full max-h-full"></video>
                <div x-show="!videoPreviewUrl" class="text-center text-white p-4"><p>İşlenmiş video burada görünecektir.</p></div>
            </main>
            <footer class="bg-background-light dark:bg-background-dark shadow-inner pt-2 pb-5">
                <nav class="flex justify-around items-center">
                    <a href="#" @click.prevent="currentScreen = 'preview'" class="flex flex-col items-center gap-1 text-primary">
                        <div class="p-2 bg-primary/20 rounded-full"><span class="material-symbols-outlined">movie</span></div>
                        <span class="text-xs font-medium">Önizleme</span>
                    </a>
                    <a href="#" @click.prevent="currentScreen = 'editor'" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">subtitles</span></div>
                        <span class="text-xs font-medium">Altyazılar</span>
                    </a>
                    <a href="#" @click.prevent="currentScreen = 'style_editor'" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">tune</span></div>
                        <span class="text-xs font-medium">Stil</span>
                    </a>
                    <a href="#" @click.prevent="handleDownload" :class="{'opacity-50 cursor-not-allowed': !videoPreviewUrl}" class="flex flex-col items-center gap-1 text-black/60 dark:text-white/60">
                         <div class="p-2"><span class="material-symbols-outlined">download</span></div>
                        <span class="text-xs font-medium">İndir</span>
                    </a>
                </nav>
            </footer>

            <!-- Logs Panel -->
            <div x-show="logsOpen" @click.away="logsOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-4" class="absolute top-16 right-4 w-full max-w-md bg-background-light dark:bg-background-dark shadow-lg rounded-lg p-4 z-20 border border-gray-200/20 dark:border-gray-700/50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg">İşlem Kayıtları</h3>
                    <button @click="copyLogsToClipboard" class="flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 px-3 py-1 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <span class="material-symbols-outlined mr-2 text-base">content_copy</span>
                        <span x-text="logCopyButtonText">Kopyala</span>
                    </button>
                </div>
                <div class="p-2 rounded bg-gray-100 dark:bg-gray-800 h-64 overflow-y-auto">
                    <pre class="text-xs text-gray-600 dark:text-gray-400" x-text="logs.join('\n') || 'Görüntülenecek kayıt yok.'"></pre>
                </div>
            </div>
        </div>

        <!-- 3. Altyazı Düzenleyici Ekranı -->
        <div x-show="currentScreen === 'editor'" x-transition.opacity.duration.200ms class="flex flex-col h-screen">
            <header class="flex items-center justify-between border-b border-gray-200/10 p-4 backdrop-blur-sm">
                <button @click="currentScreen = 'preview'" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 class="text-lg font-bold">Altyazı Düzenleyici</h1>
                <div class="flex items-center gap-2">
                    <button @click="undo()" :disabled="historyIndex <= 0" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20 disabled:opacity-50">
                        <span class="material-symbols-outlined">undo</span>
                    </button>
                    <button @click="redo()" :disabled="historyIndex >= history.length - 1" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20 disabled:opacity-50">
                        <span class="material-symbols-outlined">redo</span>
                    </button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4" x-show="currentSubtitles.length > 0">
                <div class="space-y-6">
                    <div class="rounded-lg border border-primary/50 bg-background-light/50 p-4 shadow-lg ring-1 ring-primary/20 dark:bg-background-dark/50"
                         @input="recordHistory()">
                        <div class="mb-3 flex items-center justify-between">
                             <div class="flex items-center gap-3">
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].speaker" class="inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-1 text-xs font-semibold text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 border-0 focus:ring-2 focus:ring-primary">
                                <div class="flex items-center gap-2 rounded-full bg-gray-200 dark:bg-gray-700 pl-3">
                                    <input type="color" 
                                           :value="getCurrentSubtitleColor()"
                                           @input.debounce.150ms="currentSubtitles[activeSubtitleIndex].overrideColor = $event.target.value; recordHistory()"
                                           class="w-6 h-6 p-0 border-0 rounded-full cursor-pointer appearance-none bg-transparent">
                                    <input type="text" 
                                           :value="getCurrentSubtitleColor()"
                                           @input.debounce.300ms="currentSubtitles[activeSubtitleIndex].overrideColor = $event.target.value; recordHistory()"
                                           class="w-20 bg-transparent text-xs font-mono focus:ring-0 border-0">
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400" x-text="(activeSubtitleIndex + 1) + ' / ' + currentSubtitles.length"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Başlangıç</label>
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].startTime" class="mt-1 block w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Bitiş</label>
                                <input type="text" x-model="currentSubtitles[activeSubtitleIndex].endTime" class="mt-1 block w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white">
                            </div>
                </div>
                        <div class="mt-3">
                            <textarea x-model="currentSubtitles[activeSubtitleIndex].line" class="min-h-[100px] w-full rounded border-gray-200/20 bg-background-light/30 p-2 text-sm text-gray-900 focus:border-primary focus:ring-primary dark:bg-background-dark/30 dark:text-white" rows="4"></textarea>
            </div>
        </div>
                    <div class="flex items-center justify-between">
                        <button @click="prevSubtitle()" :disabled="activeSubtitleIndex === 0" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 disabled:opacity-50"><span class="material-symbols-outlined">chevron_left</span></button>
                        <div class="flex items-center gap-2">
                             <template x-for="(sub, index) in currentSubtitles.slice(Math.max(0, activeSubtitleIndex-2), Math.min(currentSubtitles.length, activeSubtitleIndex+3))">
                                <button @click="activeSubtitleIndex = currentSubtitles.indexOf(sub)" class="h-2.5 w-2.5 rounded-full" :class="currentSubtitles.indexOf(sub) === activeSubtitleIndex ? 'bg-primary' : 'bg-gray-300 dark:bg-gray-600'"></button>
                            </template>
                        </div>
                        <button @click="nextSubtitle()" :disabled="activeSubtitleIndex === currentSubtitles.length - 1" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 disabled:opacity-50"><span class="material-symbols-outlined">chevron_right</span></button>
            </div>
        </div>
            </main>
             <footer class="sticky bottom-0 border-t border-gray-200/10 bg-background-light/80 p-4 backdrop-blur-sm dark:bg-background-dark/80">
                <button @click="reprocessVideo()" :disabled="isLoading" class="w-full rounded-lg bg-primary py-3 text-sm font-bold text-white transition hover:bg-primary/90 disabled:bg-gray-400">
                    <span x-text="isLoading ? 'Uygulanıyor...' : 'Değişiklikleri Kaydet ve Uygula'"></span>
                </button>
            </footer>
    </div>

        <!-- 4. Stil Düzenleyici Ekranı -->
        <div x-show="currentScreen === 'style_editor'" x-transition.opacity.duration.200ms class="flex flex-col h-screen">
             <header class="flex items-center justify-between border-b border-gray-200/10 p-4 backdrop-blur-sm">
                <button @click="currentScreen = 'preview'" class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-gray-500/10 dark:text-gray-400 dark:hover:bg-gray-500/20"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 class="text-lg font-bold">Stil ve Zamanlama Ayarları</h1>
                <div class="h-10 w-10"></div>
            </header>
            <main class="flex-1 overflow-y-auto p-6">
                 <div class="grid grid-cols-1 gap-6">
                     <div>
                        <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">Altyazı Stili</h3>
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                                    <span>Metin Boyutu</span><span x-text="styleSettings.fontSize"></span>
                                </label>
                                <input type="range" min="8" max="72" x-model="styleSettings.fontSize" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
                            </div>
                            <div class="space-y-2">
                                <label class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                                    <span>Dikey Konum</span><span x-text="styleSettings.marginV"></span>
                                </label>
                                <input type="range" min="10" max="200" x-model="styleSettings.marginV" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">İtalik Metin</label>
                                <input type="checkbox" x-model="styleSettings.italic" class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            </div>
                             <div class="control-item">
                                <label for="font-upload" class="w-full flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                                    <span class="material-symbols-outlined mr-2 text-base">font_download</span>
                                    <span>Font Değiştir (.ttf, .otf)</span>
                                 </label>
                                <input type="file" id="font-upload" accept=".ttf,.otf" class="hidden">
                            </div>
                        </div>
                    </div>
                    <!-- Speaker Colors -->
                    <div class="border-t border-gray-200 dark:border-gray-700 mt-6 pt-6">
                        <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">Varsayılan Konuşmacı Renkleri</h3>
                        <div class="space-y-3">
                            <template x-for="(color, speaker) in styleSettings.speakerColors" :key="speaker">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="speaker"></label>
                                    <div class="flex items-center gap-2 rounded-full bg-gray-200 dark:bg-gray-700 pl-3">
                                        <input type="color" 
                                               :value="styleSettings.speakerColors[speaker] || '#ffffff'"
                                               @input="styleSettings.speakerColors[speaker] = $event.target.value"
                                               class="w-6 h-6 p-0 border-0 rounded-full cursor-pointer appearance-none bg-transparent">
                                        <input type="text" 
                                               :value="styleSettings.speakerColors[speaker] || '#ffffff'"
                                               @input="styleSettings.speakerColors[speaker] = $event.target.value"
                                               placeholder="#ffffff"
                                               class="w-20 bg-transparent text-xs font-mono focus:ring-0 border-0">
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                     <div class="border-t border-gray-200 dark:border-gray-700 mt-6 pt-6">
                        <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">Altyazı Zamanlaması</h3>
                        <div class="space-y-2">
                            <label class="flex justify-between text-sm font-medium text-gray-700 dark:text-gray-300">
                                <span>Uzatma Süresi (s)</span><span x-text="styleSettings.extendDuration"></span>
                            </label>
                            <input type="range" min="0" max="5" step="0.1" x-model="styleSettings.extendDuration" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary">
        </div>
                        <div class="mt-6 flex justify-end">
                            <button @click="extendAllDurations" class="flex items-center justify-center rounded bg-primary px-6 py-3 text-sm font-bold text-white hover:bg-opacity-90 transition-colors">
                                <span>Tüm Bitiş Sürelerini Uzat</span>
                            </button>
        </div>
        </div>
    </div>
            </main>
             <footer class="sticky bottom-0 border-t border-gray-200/10 bg-background-light/80 p-4 backdrop-blur-sm dark:bg-background-dark/80">
                <button @click="reprocessVideo()" :disabled="isLoading" class="w-full rounded-lg bg-primary py-3 text-sm font-bold text-white transition hover:bg-primary/90 disabled:bg-gray-400">
                     <span x-text="isLoading ? 'Uygulanıyor...' : 'Stil Değişikliklerini Uygula'"></span>
                </button>
            </footer>
    </div>

    </div>

    <script>
    function videoEditor() {
        return {
            // --- STATE ---
            currentScreen: 'upload', // 'upload', 'preview', 'editor', 'style_editor'
            fileName: 'None',
            statusMessage: '',
            statusType: 'processing', // 'processing', 'success', 'error'
            logs: [],
            isLoading: false,
            logsOpen: false,
            logCopyButtonText: 'Kopyala',
            
            originalVideoFile: null, // Orijinal video dosyasını saklamak için
            currentVideoPath: '', // Bu artık Vercel için kullanılmayacak
            videoPreviewUrl: '',
            currentSubtitles: [],
            activeSubtitleIndex: 0,
            history: [],
            historyIndex: -1,
            
            // Style Settings
            styleSettings: {
                fontSize: 12,
                marginV: 60,
                extendDuration: 0.5,
                italic: false,
                speakerColors: {} // Başlangıçta boş, dinamik dolacak
            },

            // --- METHODS ---
            
            // --- Navigation ---
            nextSubtitle() {
                if (this.activeSubtitleIndex < this.currentSubtitles.length - 1) {
                    this.activeSubtitleIndex++;
                }
            },
            prevSubtitle() {
                if (this.activeSubtitleIndex > 0) {
                    this.activeSubtitleIndex--;
                }
            },
            
            // --- History ---
            recordHistory: _.debounce(function() {
                if (this.historyIndex < this.history.length - 1) {
                    this.history.splice(this.historyIndex + 1);
                }
                this.history.push(JSON.parse(JSON.stringify(this.currentSubtitles)));
                this.historyIndex++;
            }, 300),

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.currentSubtitles = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                }
            },

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.currentSubtitles = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                }
            },

            // --- UI Helpers ---
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.fileName = file.name;
                    this.originalVideoFile = file; // Dosyayı state'e kaydet
                } else {
                    this.fileName = 'Hiçbiri';
                    this.originalVideoFile = null;
                }
            },
            
            addLog(message) {
                this.logs.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            },
            
            getCurrentSubtitleColor() {
                const currentSub = this.currentSubtitles[this.activeSubtitleIndex];
                if (!currentSub) return '#ffffff';
                
                // Önce override rengi kontrol et
                if (currentSub.overrideColor) {
                    return currentSub.overrideColor;
                }
                
                // Sonra konuşmacının varsayılan rengini kontrol et
                if (currentSub.speaker && this.styleSettings.speakerColors[currentSub.speaker]) {
                    return this.styleSettings.speakerColors[currentSub.speaker];
                }
                
                // Son olarak varsayılan renk
                return '#ffff00'; // Sarı
            },
            
            updateStatus(message, type, logs = null) {
                this.statusMessage = message;
                this.statusType = type;
                if(logs) {
                    this.logs = Array.isArray(logs) ? logs : [logs];
                }
            },
            
            copyLogsToClipboard() {
                navigator.clipboard.writeText(this.logs.join('\n')).then(() => {
                    this.logCopyButtonText = 'Kopyalandı!';
                    setTimeout(() => this.logCopyButtonText = 'Kopyala', 2000);
                }).catch(err => {
                    console.error('Loglar kopyalanamadı: ', err);
                    this.logCopyButtonText = 'Hata!';
                    setTimeout(() => this.logCopyButtonText = 'Kopyala', 2000);
                });
            },
            
            populateSpeakerColors() {
                const colors = ['#FFFF00', '#FFFFFF', '#00FFFF', '#FF00FF', '#00FF00']; // Sarı, Beyaz, Mavi, Pembe, Yeşil
                const speakers = new Set(this.currentSubtitles.map(s => s.speaker));
                const newSpeakerColors = {};
                let colorIndex = 0;
                speakers.forEach(speaker => {
                    if (!this.styleSettings.speakerColors[speaker]) {
                         newSpeakerColors[speaker] = colors[colorIndex % colors.length];
                         colorIndex++;
                    } else {
                        newSpeakerColors[speaker] = this.styleSettings.speakerColors[speaker];
                    }
                });
                this.styleSettings.speakerColors = newSpeakerColors;
                
                // Altyazıların overrideColor alanlarını da güncelle - Alpine.js'in algılaması için yeni dizi oluştur
                this.currentSubtitles = this.currentSubtitles.map(sub => {
                    if (!sub.overrideColor && sub.speaker && this.styleSettings.speakerColors[sub.speaker]) {
                        return { ...sub, overrideColor: this.styleSettings.speakerColors[sub.speaker] };
                    }
                    return sub;
                });
            },

            // --- API Calls ---
            async handleUpload() {
                const videoInput = document.getElementById('video-upload');
                if (!videoInput.files[0]) {
                    this.updateStatus('Lütfen önce bir video dosyası seçin.', 'error');
                    return;
                }

                this.isLoading = true;
                this.logs = []; // Logları temizle
                this.updateStatus('Video yükleniyor ve işleniyor...', 'processing');
                
                // Anlık log güncellemesi için
                this.addLog('📤 Video yükleniyor...');

                const formData = new FormData();
                formData.append('video', videoInput.files[0]);

                try {
                    const response = await fetch('/api/upload', { method: 'POST', body: formData });
                    const result = await response.json();
                    
                    // Logları anlık olarak güncelle
                    if (result.logs && Array.isArray(result.logs)) {
                        this.logs = [...result.logs];
                    }

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Sunucu hatası oluştu.');
                    }

                    this.updateStatus('Başarıyla tamamlandı!', 'success');
                    
                    // Vercel API'den gelen veriyi işle
                    if (result.videoData) {
                        // Base64 video data'sını blob URL'e çevir
                        const videoBlob = new Blob([Uint8Array.from(atob(result.videoData), c => c.charCodeAt(0))], { type: 'video/mp4' });
                        this.videoPreviewUrl = URL.createObjectURL(videoBlob);
                    } else {
                        this.videoPreviewUrl = result.downloadUrl;
                    }
                    
                    // Altyazıları işle
                    if (result.subtitles && result.subtitles.subtitles) {
                        this.currentSubtitles = result.subtitles.subtitles.map(s => ({
                            ...s, 
                            startTime: s.startTime.toFixed(3), 
                            endTime: s.endTime.toFixed(3),
                            overrideColor: ''
                        }));
                    } else {
                        // Fallback: boş altyazı listesi
                        this.currentSubtitles = [];
                    }
                    
                    this.activeSubtitleIndex = 0;
                    this.populateSpeakerColors();
                    // History init
                    this.history = [JSON.parse(JSON.stringify(this.currentSubtitles))];
                    this.historyIndex = 0;
                    this.currentScreen = 'preview';

                } catch (error) {
                    console.error('Yükleme hatası:', error);
                    this.addLog('❌ Hata: ' + error.message);
                    this.updateStatus(error.message, 'error');
                } finally {
                    this.isLoading = false;
                }
            },

            async reprocessVideo() {
                if (!this.originalVideoFile || !this.currentSubtitles) {
                    this.updateStatus('Yeniden işlemek için video verisi bulunamadı.', 'error');
                    return;
                }

                this.isLoading = true;
                this.logs = []; // Logları temizle
                this.updateStatus('Değişiklikler uygulanıyor...', 'processing');
                this.addLog('🔄 Video yeniden işleniyor...');
                
                const formData = new FormData();
                formData.append('video', this.originalVideoFile); // Orijinal video dosyasını gönder
                
                // Convert times back to float for processing
                const subtitlesToProcess = this.currentSubtitles.map(s => ({
                    ...s,
                    startTime: parseFloat(s.startTime),
                    endTime: parseFloat(s.endTime)
                }));
                formData.append('subtitles', JSON.stringify({ subtitles: subtitlesToProcess }));
                
                formData.append('fontSize', this.styleSettings.fontSize);
                formData.append('marginV', this.styleSettings.marginV);
                formData.append('italic', this.styleSettings.italic);
                formData.append('speakerColors', JSON.stringify(this.styleSettings.speakerColors));

                const fontInput = document.getElementById('font-upload');
                if (fontInput.files[0]) {
                    formData.append('font', fontInput.files[0]);
                    this.addLog('📁 Özel font dosyası yüklendi');
                }

                try {
                    const response = await fetch('/api/reprocess', { method: 'POST', body: formData });
                    const result = await response.json();
                    
                    // Logları anlık olarak güncelle
                    if (result.logs && Array.isArray(result.logs)) {
                        this.logs = [...result.logs];
                    }

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Sunucu hatası oluştu.');
                    }
                    
                    this.updateStatus('Değişiklikler başarıyla uygulandı!', 'success');
                    
                    // Vercel API'den gelen veriyi işle
                    if (result.videoData) {
                        // Base64 video data'sını blob URL'e çevir
                        const videoBlob = new Blob([Uint8Array.from(atob(result.videoData), c => c.charCodeAt(0))], { type: 'video/mp4' });
                        this.videoPreviewUrl = URL.createObjectURL(videoBlob);
                                } else {
                        this.videoPreviewUrl = result.downloadUrl + `?t=${new Date().getTime()}`; // Cache bust
                    }
                    
                    this.currentScreen = 'preview';

                } catch (error) {
                    console.error('Yeniden işleme hatası:', error);
                    this.addLog('❌ Hata: ' + error.message);
                    this.updateStatus(error.message, 'error');
                } finally {
                    this.isLoading = false;
                }
            },

            handleDownload() {
                if (!this.videoPreviewUrl) return;
                            const a = document.createElement('a');
                a.href = this.videoPreviewUrl.split('?')[0]; // Sorunlu cache-busting parametresini kaldır
                a.download = `subtitled_video_${Date.now()}.mp4`; // Temiz bir dosya adı ver
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
            },
            
            extendAllDurations() {
                const extendSeconds = parseFloat(this.styleSettings.extendDuration);
                if (isNaN(extendSeconds) || extendSeconds <= 0) {
                    alert('Lütfen geçerli bir uzatma süresi girin.');
                    return;
                }
            
                const updatedSubs = this.currentSubtitles.map((sub, i) => {
                    const nextSub = this.currentSubtitles[i + 1];
                    const currentEndTime = parseFloat(sub.endTime);
                    let potentialNewEndTime = currentEndTime + extendSeconds;
            
                    if (nextSub && potentialNewEndTime > parseFloat(nextSub.startTime)) {
                        potentialNewEndTime = parseFloat(nextSub.startTime);
                    }
                    return {...sub, endTime: potentialNewEndTime.toFixed(3)};
                });
                
                this.currentSubtitles = updatedSubs;
                alert('Bitiş süreleri güncellendi. Değişiklikleri kalıcı hale getirmek için "Stil Değişikliklerini Uygula" butonuna tıklayın.');
            }
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</body>
</html>
